import router from '@ohos.router'
import common from '@ohos.app.ability.common'
import web_webview from '@ohos.web.webview'

@Entry
@Component
struct MonitorPage {
  @State debugText: string = ''
  @State isLoading: boolean = true
  @State showAlert: boolean = false         // è€äººæ‘”å€’å¼¹çª—æ§åˆ¶
  @State showGasAlert: boolean = false      // å¯ç‡ƒæ°”ä½“å¼¹çª—æ§åˆ¶

  private context = getContext(this) as common.UIAbilityContext
  private cameraIP: string = '192.168.10.229'
  private controller: web_webview.WebviewController = new web_webview.WebviewController()

  // é¡µé¢è¿›å…¥åè§¦å‘æ°”ä½“æŠ¥è­¦
  aboutToAppear(): void {
    setTimeout(() => {
      this.showGasLeakAlert()
    }, 5000)
  }

  // æ‘”å€’å¼¹çª—
  showFallAlert(): void {
    this.showAlert = true
    setTimeout(() => {
      this.showAlert = false
    }, 5000)
  }

  // æ°”ä½“æŠ¥è­¦å¼¹çª—
  showGasLeakAlert(): void {
    this.showGasAlert = true
    setTimeout(() => {
      this.showGasAlert = false
    }, 5000)
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Image($r('app.media.back'))
          .width(24)
          .height(24)
          .margin({ left: 16 })
          .onClick(() => {
            router.back()
          })
        Text('ç›‘æ§ç”»é¢')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .margin({ left: 16 })
      }
      .width('100%')
      .height(56)
      .backgroundColor('#FFFFFF')

      // è§†é¢‘ + å¼¹çª—
      Stack() {
        // è§†é¢‘æµåŠ è½½
        Web({
          src: `http://${this.cameraIP}/stream`,
          controller: this.controller
        })
          .width('100%')
          .height('100%')
          .onPageBegin(() => {
            this.isLoading = false
          })
          .onErrorReceive((event) => {
            this.debugText = 'è§†é¢‘åŠ è½½å¤±è´¥'
            this.isLoading = false
          })

        // åŠ è½½æŒ‡ç¤ºå™¨
        if (this.isLoading) {
          Column() {
            LoadingProgress()
              .width(64)
              .height(64)
            Text('æ­£åœ¨è¿æ¥æ‘„åƒå¤´...')
              .fontSize(14)
              .fontColor('#FFFFFF')
              .margin({ top: 8 })
          }
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0, 0, 0, 0.5)')
          .justifyContent(FlexAlign.Center)
        }

        // çŠ¶æ€æç¤º
        if (this.debugText) {
          Text(this.debugText)
            .fontSize(14)
            .fontColor('#FFFFFF')
            .backgroundColor('rgba(0, 0, 0, 0.5)')
            .padding(8)
            .borderRadius(4)
            .position({ x: '50%', y: 20 })
            .translate({ x: '-50%' })
        }

        // ğŸš¨ è€äººæ‘”å€’å¼¹çª—
        if (this.showAlert) {
          Column() {
            Text('âš ï¸ æ£€æµ‹åˆ°è€äººæ‘”å€’')
              .fontSize(26)
              .fontWeight(FontWeight.Bold)
              .fontColor('#FFFFFF')
              .margin({ bottom: 16 })

            Text('æ­£åœ¨é€šçŸ¥ç›‘æŠ¤äºº...')
              .fontSize(20)
              .fontColor('#FFFFFF')
          }
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(200, 0, 0, 0.85)')
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
        }

        // ğŸ§¯ å¯ç‡ƒæ°”ä½“æŠ¥è­¦å¼¹çª—
        if (this.showGasAlert) {
          Column() {
            Text('âš ï¸ æ£€æµ‹åˆ°éæ³•é—¯å…¥')
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#FFFFFF')
              .margin({ bottom: 16 })

            Text('å·²è¿›è¡Œäººè„¸æŠ“æ‹ï¼Œè¯·ç¡®è®¤æˆ¿å±‹æ˜¯å¦å®‰å…¨')
              .fontSize(18)
              .fontColor('#FFFFFF')
              .textAlign(TextAlign.Center)
              .padding({ left: 20, right: 20 })
          }
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(255, 69, 0, 0.85)')
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
        }
      }
      .width('100%')
      .layoutWeight(1)
      .backgroundColor('#000000')
    }
    .width('100%')
    .height('100%')
  }
}
