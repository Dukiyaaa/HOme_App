// =====================================================
// ðŸ“¦ æ¨¡å—ä¸€ï¼šå¯¼å…¥ä¾èµ–æ¨¡å—
// =====================================================
import { chatPop } from '../models/ChatPop'
import { http } from '@kit.NetworkKit'
import { UserInfoComp } from '../component/UserInfoComp'
import { UserData } from '../models/UserData'

// =====================================================
// ðŸ§¾ æ¨¡å—äºŒï¼šç±»åž‹æŽ¥å£å®šä¹‰
// =====================================================
interface ChatReply {
  reply?: string
}
// =====================================================
// ðŸ¤– æ¨¡å—ä¸‰ï¼šAI èŠå¤©é¡µé¢ç»„ä»¶å®šä¹‰
// =====================================================
@Entry
@Component
export struct AIPage {

  // =====================================================
  // ðŸ“Š çŠ¶æ€å˜é‡å®šä¹‰
  // =====================================================
  @State message: string = 'Hello World'
  @State touxiang: Resource = $r('app.media.touxiang')
  @State username: string = 'SystemAI'
  @State hasContent: number = 0
  @State chatMessages: chatPop[] = []
  @State inputMessage: string = ''
  @State nowId: number = 0
  //ç”¨æˆ·ä¿¡æ¯æ•°æ®
  @State userData:UserData=new UserData()

  // =====================================================
  // ðŸ—ï¸ é¡µé¢æž„å»ºå‡½æ•° build()
  // =====================================================
  build() {
    Column() {

      // ðŸ§± é¡¶éƒ¨åŒºåŸŸ
      //ç”¨æˆ·ä¿¡æ¯æ 
      UserInfoComp({userData:this.userData})

      // ðŸ’¬ èŠå¤©å†…å®¹åŒºåŸŸ
      Stack({ alignContent: Alignment.Center }) {

        // ðŸ“­ æ— èŠå¤©å†…å®¹æç¤º
        if (this.hasContent == 0) {
          Text('æˆ‘èƒ½å¸®åŠ©ä½ ä»€ä¹ˆï¼Ÿ').fontSize(20)
        }

        // ðŸ“‹ æœ‰èŠå¤©å†…å®¹å±•ç¤º
        if (this.hasContent != 0) {
          List({ space: 10 }) {
            ForEach(this.chatMessages, (messages: chatPop) => {
              ListItem() {
                Row() {
                  if (messages.username != 'SystemAI') {
                    Blank()
                  }

                  Text(messages.message)
                    .width('fit-content')
                    .padding({ left: 15, right: 15, top: 10, bottom: 10 })
                    .backgroundColor('#E0F7FA')
                    .borderRadius(
                      messages.username == 'SystemAI'
                        ? { topLeft: 15, bottomLeft: 0, topRight: 15, bottomRight: 15 }
                        : { topLeft: 15, bottomLeft: 15, topRight: 15, bottomRight: 0 }
                    )
                    .margin({ left: 15, right: 15, top: 5, bottom: 5 })
                }.width('100%')
              }
            }, (messages: chatPop) => messages.id.toString())
          }
          .width('100%')
          .height('90%')
        }

        // âŒ¨ï¸ è¾“å…¥æ¡† + å‘é€æŒ‰é’®
        Row() {
          TextArea({
            placeholder: 'è¯·è¾“å…¥æ¶ˆæ¯',
            text: this.inputMessage,
          })
            .onChange((value: string) => {
              this.inputMessage = value
            })
            .width('82%')

          Button('å‘é€')
            .width('18%')
            .onClick(() => {
              if (this.inputMessage.trim() !== '') {
                const userText = this.inputMessage

                // 1ï¸âƒ£ æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                this.chatMessages.push({
                  id: this.nowId,
                  username: this.username,
                  message: userText
                })
                this.nowId++
                this.hasContent = 1
                this.inputMessage = ''
                // 2ï¸âƒ£ è°ƒç”¨ AI æŽ¥å£èŽ·å–å›žå¤
                const req = http.createHttp()
                req.request('http://43.155.36.236:5000/chat', {
                  method: http.RequestMethod.POST,
                  header: {
                    'Content-Type': 'application/json'
                  },
                  extraData: JSON.stringify({ message: userText }),
                  readTimeout: 100000
                })
                  .then((res: http.HttpResponse) => {
                    let replyMsg: string = 'æ— å›žå¤'

                    if (typeof res.result === 'string') {
                      try {
                        const json = JSON.parse(res.result) as ChatReply
                        if (json && typeof json.reply === 'string') {
                          replyMsg = json.reply
                        }
                      } catch (e) {
                        console.error('è§£æž AI å›žå¤å¤±è´¥ï¼š', e)
                      }
                    }

                    this.chatMessages.push({
                      id: this.nowId,
                      username: 'AIåŠ©æ‰‹',
                      message: replyMsg
                    })
                    this.nowId++
                  })
                  .catch(() => {
                    this.chatMessages.push({
                      id: this.nowId,
                      username: 'AIåŠ©æ‰‹',
                      message: 'è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦åœ¨çº¿'
                    })
                    this.nowId++
                  })
                  .finally(() => {
                    req.destroy()
                  })
              }
            })
        }
        .height('10%')
        .alignItems(VerticalAlign.Center)
        .position({ bottom: 0 })
      }
      .width('95%')
      .height('90%')

    }
    .width('100%')
    .height('100%')
  }
}
