import router from '@ohos.router'
import common from '@ohos.app.ability.common'
import web_webview from '@ohos.web.webview'
import http from '@ohos.net.http'

// ä½¿ç”¨classä»£æ›¿interfaceæ¥å®šä¹‰ç±»å‹
class RecognitionResultItem {
  name: string = ''
}

class RecognitionResult {
  faces_detected: number = 0
  results: RecognitionResultItem[] = []
}

@Entry
@Component
struct FaceRecognitionPage {
  @State debugText: string = ''
  @State isLoading: boolean = true
  @State recognitionResult: string = ''
  private context = getContext(this) as common.UIAbilityContext
  private cameraIP: string = '192.168.10.229'
  private serverURL: string = 'http://43.155.36.236:5000/upload_photo'
  private controller: web_webview.WebviewController = new web_webview.WebviewController()
  private isUnloaded: boolean = false

  aboutToAppear(): void {
    this.isUnloaded = false
  }

  aboutToDisappear(): void {
    this.isUnloaded = true
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Image($r('app.media.back'))
          .width(24)
          .height(24)
          .margin({ left: 16 })
          .onClick(() => {
            router.back()
          })
        Text('äººè„¸è¯†åˆ«')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .margin({ left: 16 })
      }
      .width('100%')
      .height(56)
      .backgroundColor('#FFFFFF')

      // è§†é¢‘é¢„è§ˆåŒºåŸŸå®¹å™¨
      Column() {
        Stack() {
          // è§†é¢‘é¢„è§ˆåŒºåŸŸ
          Web({
            src: `http://${this.cameraIP}/stream`,
            controller: this.controller
          })
          .width('100%')
          .height('100%')
          .onPageBegin(() => {
            this.isLoading = false
          })
          .onErrorReceive((event) => {
            this.debugText = 'è§†é¢‘åŠ è½½å¤±è´¥'
            this.isLoading = false
          })

          // åŠ è½½æŒ‡ç¤ºå™¨
          if (this.isLoading) {
            Column() {
              LoadingProgress()
                .width(64)
                .height(64)
              Text('æ­£åœ¨è¿æ¥æ‘„åƒå¤´...')
                .fontSize(14)
                .fontColor('#FFFFFF')
                .margin({ top: 8 })
            }
            .width('100%')
            .height('100%')
            .backgroundColor('rgba(0, 0, 0, 0.5)')
            .justifyContent(FlexAlign.Center)
          }

          // çŠ¶æ€æ–‡æœ¬
          if (this.debugText) {
            Text(this.debugText)
              .fontSize(14)
              .fontColor('#FFFFFF')
              .backgroundColor('rgba(0, 0, 0, 0.5)')
              .padding(8)
              .borderRadius(4)
              .position({ x: '50%', y: 20 })
              .translate({ x: '-50%' })
          }
        }
        .width('90%')
        .height('100%')
        .backgroundColor('#000000')
        .borderRadius(12)
      }
      .width('100%')
      .height('45%')
      .backgroundColor('#F5F5F5')
      .padding({ top: 20, bottom: 20 })
      .justifyContent(FlexAlign.Center)

      // è¯†åˆ«ç»“æœæ˜¾ç¤º
      if (this.recognitionResult) {
        Text(this.recognitionResult)
          .fontSize(16)
          .fontColor('#333333')
          .margin({ top: 20 })
      }

      // ç©ºç™½é—´è·
      Blank()
        .layoutWeight(1)
        .backgroundColor('#F5F5F5')

      // åº•éƒ¨æŒ‰é’®åŒºåŸŸ
      Row() {
        Button('ğŸ“¸ ç‚¹å‡»è¯†åˆ«å¼€é—¨')
          .width('80%')
          .height(50)
          .backgroundColor('#5686E1')
          .fontColor(Color.White)
          .borderRadius(25)
          .onClick(() => {
            this.performFaceRecognition()
          })
      }
      .width('100%')
      .padding(20)
      .backgroundColor('#FFFFFF')
      .justifyContent(FlexAlign.Center)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  // æ‰§è¡Œäººè„¸è¯†åˆ«
  private async performFaceRecognition(): Promise<void> {
    try {
      this.debugText = '[å‰ç«¯ğŸ“¸] å¼€å§‹æ‹ç…§...'
      const timestamp = Date.now()
      const request = http.createHttp()

      console.log('[å‰ç«¯ğŸ“¸] è¯·æ±‚é«˜æ¸…å›¾åƒï¼š', `http://${this.cameraIP}/capture_hd?time=${timestamp}`)

      const captureResponse = await request.request(
        `http://${this.cameraIP}/capture_hd?time=${timestamp}`,
        {
          method: http.RequestMethod.GET,
          expectDataType: http.HttpDataType.ARRAY_BUFFER
        }
      )

      console.log('[å‰ç«¯ğŸ“¥] æ‹ç…§å“åº”çŠ¶æ€ç ï¼š', captureResponse.responseCode)

      if (captureResponse.responseCode === 200) {
        this.debugText = '[å‰ç«¯ğŸ“¤] ä¸Šä¼ å›¾åƒä¸­...'
        console.log('[å‰ç«¯ğŸ“¤] å¼€å§‹ä¸Šä¼ åˆ°åç«¯æ¥å£ï¼š', this.serverURL)

        const uploadResponse = await request.request(
          this.serverURL,
          {
            method: http.RequestMethod.POST,
            header: {
              'Content-Type': 'multipart/form-data'
            },
            extraData: captureResponse.result as ArrayBuffer
          }
        )

        console.log('[å‰ç«¯ğŸ“¬] è¯†åˆ«å“åº”çŠ¶æ€ç ï¼š', uploadResponse.responseCode)

        if (uploadResponse.responseCode === 200) {
          const result = JSON.parse(uploadResponse.result as string) as RecognitionResult
          console.log('[å‰ç«¯ğŸ§ ] åç«¯è¿”å›ç»“æœï¼š', result)

          if (result.faces_detected > 0) {
            const names = result.results.map(item => item.name).join(', ')

            if (names.includes('Unknown')) {
              this.debugText = '[å‰ç«¯âš ï¸] æœªè¯†åˆ«èº«ä»½'
              this.recognitionResult = 'æœªçŸ¥äººè„¸'
            } else {
              this.debugText = `[å‰ç«¯âœ…] è¯†åˆ«åˆ°ï¼š${names}`
              this.recognitionResult = `è¯†åˆ«åˆ°ï¼š${names}`
            }
          } else {
            this.debugText = '[å‰ç«¯âŒ] æœªè¯†åˆ«åˆ°äººè„¸'
            this.recognitionResult = 'æœªè¯†åˆ«åˆ°äººè„¸'
          }
        } else {
          this.debugText = '[å‰ç«¯âš ï¸] åç«¯è¯†åˆ«å¤±è´¥'
          this.recognitionResult = 'è¯†åˆ«å¤±è´¥'
        }
      } else {
        this.debugText = '[å‰ç«¯âš ï¸] æ‘„åƒå¤´æ‹ç…§å¤±è´¥'
        this.recognitionResult = 'æ‹ç…§å¤±è´¥'
      }
    } catch (error) {
      console.error('[å‰ç«¯âŒ] å¼‚å¸¸ï¼š', error)
      this.debugText = '[å‰ç«¯âŒ] è¯†åˆ«å¼‚å¸¸'
      this.recognitionResult = 'è¯†åˆ«å¼‚å¸¸'
    }
  }
} 