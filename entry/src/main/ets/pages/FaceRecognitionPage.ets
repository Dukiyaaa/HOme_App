import router from '@ohos.router'
import common from '@ohos.app.ability.common'
import web_webview from '@ohos.web.webview'
import http from '@ohos.net.http'

// å®šä¹‰è¯†åˆ«ç»“æœç»“æ„
class RecognitionResultItem {
  name: string = ''
}
class RecognitionResult {
  faces_detected: number = 0
  results: RecognitionResultItem[] = []
}

@Entry
@Component
struct FaceRecognitionPage {
  @State debugText: string = ''
  @State isLoading: boolean = true
  @State recognitionResult: string = ''
  private context = getContext(this) as common.UIAbilityContext
  private cameraIP: string = '192.168.10.229'
  private serverURL: string = 'http://43.155.36.236:5000/upload_photo'
  private controller: web_webview.WebviewController = new web_webview.WebviewController()
  private isUnloaded: boolean = false

  private failCount: number = 0  // æ–°å¢å¤±è´¥è®¡æ•°å™¨

  aboutToAppear(): void {
    this.isUnloaded = false
  }

  aboutToDisappear(): void {
    this.isUnloaded = true
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Image($r('app.media.back'))
          .width(24)
          .height(24)
          .margin({ left: 16 })
          .onClick(() => {
            router.back()
          })
        Text('äººè„¸è¯†åˆ«')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .margin({ left: 16 })
      }
      .width('100%')
      .height(56)
      .backgroundColor('#FFFFFF')

      // è§†é¢‘åŒºåŸŸ
      Column() {
        Stack() {
          Web({
            src: `http://${this.cameraIP}/stream`,
            controller: this.controller
          })
            .width('100%')
            .height('100%')
            .onPageBegin(() => {
              this.isLoading = false
            })
            .onErrorReceive((event) => {
              this.debugText = 'è§†é¢‘åŠ è½½å¤±è´¥'
              this.isLoading = false
            })

          if (this.isLoading) {
            Column() {
              LoadingProgress()
                .width(64)
                .height(64)
              Text('æ­£åœ¨è¿æ¥æ‘„åƒå¤´...')
                .fontSize(14)
                .fontColor('#FFFFFF')
                .margin({ top: 8 })
            }
            .width('100%')
            .height('100%')
            .backgroundColor('rgba(0, 0, 0, 0.5)')
            .justifyContent(FlexAlign.Center)
          }

          if (this.debugText) {
            Text(this.debugText)
              .fontSize(14)
              .fontColor('#FFFFFF')
              .backgroundColor('rgba(0, 0, 0, 0.5)')
              .padding(8)
              .borderRadius(4)
              .position({ x: '50%', y: 20 })
              .translate({ x: '-50%' })
          }
        }
        .width('90%')
        .height('100%')
        .backgroundColor('#000000')
        .borderRadius(12)
      }
      .width('100%')
      .height('45%')
      .backgroundColor('#F5F5F5')
      .padding({ top: 20, bottom: 20 })
      .justifyContent(FlexAlign.Center)

      // è¯†åˆ«ç»“æœæ˜¾ç¤º
      if (this.recognitionResult) {
        Text(this.recognitionResult)
          .fontSize(16)
          .fontColor('#333333')
          .margin({ top: 20 })
      }

      Blank()
        .layoutWeight(1)
        .backgroundColor('#F5F5F5')

      // åº•éƒ¨è¯†åˆ«æŒ‰é’®
      Row() {
        Button('ğŸ“¸ ç‚¹å‡»è¯†åˆ«å¼€é—¨')
          .width('80%')
          .height(50)
          .backgroundColor('#5686E1')
          .fontColor(Color.White)
          .borderRadius(25)
          .onClick(() => {
            this.performFaceRecognition()
          })
      }
      .width('100%')
      .padding(20)
      .backgroundColor('#FFFFFF')
      .justifyContent(FlexAlign.Center)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  // æ¨¡æ‹Ÿè¯†åˆ«æµç¨‹
  private async performFaceRecognition(): Promise<void> {
    this.debugText = 'ğŸ“¸ æ‹ç…§ä¸­...'

    setTimeout(() => {
      this.failCount += 1

      if (this.failCount <= 3) {
        this.debugText = 'âŒ æœªè¯†åˆ«åˆ°æœ‰æ•ˆäººè„¸'
        this.recognitionResult = `è¯†åˆ«å¤±è´¥ ç¬¬ ${this.failCount} æ¬¡`

        AlertDialog.show({
          title: 'è¯†åˆ«å¤±è´¥',
          message: `æœªè¯†åˆ«åˆ°æœ‰æ•ˆäººè„¸ï¼ˆç¬¬ ${this.failCount} æ¬¡ï¼‰`,
          confirm: {
            value: 'ç¡®å®š',
            action: () => {}
          }
        })
      } else {
        this.debugText = 'ğŸš¨ æ£€æµ‹åˆ°å¼‚å¸¸è¯†åˆ«è¡Œä¸º'
        this.recognitionResult = 'âš ï¸ æ£€æµ‹åˆ°éæ³•é—¯å…¥'

        AlertDialog.show({
          title: 'æŠ¥è­¦æç¤º',
          message: 'æ£€æµ‹åˆ°æœ‰äººè¯•å›¾éæ³•é—¯å…¥ï¼Œè¯·æ£€æµ‹æˆ¿å±‹æ˜¯å¦å®‰å…¨ â—ï¸',
          confirm: {
            value: 'æˆ‘çŸ¥é“äº†',
            action: () => {}
          }
        })

        this.failCount = 0 // å¯é€‰ï¼šé‡ç½®è®¡æ•°å™¨
      }
    }, 3000)
  }
}
